@page "/change-password"
@using global::Employees.Frontend.Repositories
@inject IRepository Repository

<h3>Cambiar contraseña</h3>

@if (!string.IsNullOrEmpty(_message))
{
    <p class="@_messageCss">@_message</p>
}

<EditForm Model="_model" OnValidSubmit="ChangeAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Contraseña actual</label>
        <InputText class="form-control" @bind-Value="_model.OldPassword" type="password" />
    </div>

    <div class="mb-3">
        <label>Nueva contraseña</label>
        <InputText class="form-control" @bind-Value="_model.NewPassword" type="password" />
    </div>

    <div class="mb-3">
        <label>Confirmar nueva contraseña</label>
        <InputText class="form-control" @bind-Value="_model.ConfirmNewPassword" type="password" />
    </div>

    <button type="submit" class="btn btn-primary">Cambiar contraseña</button>
</EditForm>

@code {
    private global::Employees.Shared.DTOs.ChangePasswordDTO _model = new();

    private string? _message;
    private string _messageCss = "text-danger";

    private async Task ChangeAsync()
    {
        _message = null;

        if (_model.NewPassword != _model.ConfirmNewPassword)
        {
            _messageCss = "text-danger";
            _message = "La confirmación de la nueva contraseña no coincide.";
            return;
        }

        var resp = await Repository.PostAsync<
            global::Employees.Shared.DTOs.ChangePasswordDTO,
            string>("api/accounts/changePassword", _model);

        if (resp.Error)
        {
            var status = resp.HttpResponseMessage?.StatusCode.ToString() ?? "desconocido";
            _messageCss = "text-danger";
            _message = $"No se pudo cambiar la contraseña. Código: {status}.";
            return;
        }

        _messageCss = "text-success";
        _message = "Contraseña cambiada correctamente.";
    }
}
