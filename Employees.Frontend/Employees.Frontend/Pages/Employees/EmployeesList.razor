@page "/employees"
@using System.Text.Json
@inject IHttpClientFactory HttpFactory

<MudPaper Class="p-4">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
        <MudTextField @bind-Value="filter"
                      @bind-Value:event="oninput"
                      Label="Buscar (nombre o apellido)"
                      Immediate="true" />
        <MudButton OnClick="Search" Variant="Variant.Filled">BUSCAR</MudButton>
    </MudStack>

    <MudTable T="global::Employees.Shared.Entities.Employee"
              @ref="table"
              ServerData="LoadServerData"
              RowsPerPage="recordsPerPage"
              RowsPerPageOptions="new int[]{10,20,50}"
              Bordered="true"
              Hover="true">
        <HeaderContent>
            <MudTh>Nombre</MudTh>
            <MudTh>Apellido</MudTh>
            <MudTh>Activo</MudTh>
            <MudTh>Fecha Ingreso</MudTh>
            <MudTh>Salario</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.FirstName</MudTd>
            <MudTd>@context.LastName</MudTd>
            <MudTd>@(context.IsActive ? "Sí" : "No")</MudTd>
            <MudTd>@(context.HireDate?.ToString("yyyy-MM-dd"))</MudTd>
            <MudTd>@context.Salary.ToString("C0")</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Class="p-4">Sin resultados o error al cargar datos.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    private MudTable<global::Employees.Shared.Entities.Employee>? table;
    private string? filter;
    private int recordsPerPage = 10;

    private static readonly JsonSerializerOptions JsonOpts = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private async Task<MudBlazor.TableData<global::Employees.Shared.Entities.Employee>>
        LoadServerData(MudBlazor.TableState state, CancellationToken ct)
    {
        try
        {
            var client = HttpFactory.CreateClient("api-auth");

            int page = state.Page + 1;
            var f = (filter ?? string.Empty).Trim();

            var listUrl = string.IsNullOrEmpty(f)
                ? $"api/Employees/paginated?Page={page}&RecordsNumber={recordsPerPage}"
                : $"api/Employees/paginated?Page={page}&RecordsNumber={recordsPerPage}&Filter={Uri.EscapeDataString(f)}";

            var countUrl = string.IsNullOrEmpty(f)
                ? $"api/Employees/totalRecords"
                : $"api/Employees/totalRecords?Filter={Uri.EscapeDataString(f)}";

            var listJson = await client.GetStringAsync(listUrl, ct);
            var totalText = await client.GetStringAsync(countUrl, ct);

            var items = JsonSerializer.Deserialize<List<global::Employees.Shared.Entities.Employee>>(listJson, JsonOpts) ?? new();
            _ = int.TryParse(totalText, out var total);

            return new MudBlazor.TableData<global::Employees.Shared.Entities.Employee>
            {
                Items = items,
                TotalItems = total
            };
        }
        catch
        {
            return new MudBlazor.TableData<global::Employees.Shared.Entities.Employee>
            {
                Items = Array.Empty<global::Employees.Shared.Entities.Employee>(),
                TotalItems = 0
            };
        }
    }

    private async Task Search()
    {
        filter = filter?.Trim();
        if (table is not null)
            await table.ReloadServerData();
    }
}
