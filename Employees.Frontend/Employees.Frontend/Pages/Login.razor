@page "/login"
@using global::System.ComponentModel.DataAnnotations
@using global::System.Net.Http.Json
@using global::Employees.Shared.DTOs
@inject IHttpClientFactory HttpFactory
@inject global::Employees.Frontend.Services.TokenService Tokens
@inject NavigationManager Nav

<MudPaper Class="p-4 max-w-md mx-auto">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h5">Iniciar sesión</MudText>

        <EditForm Model="model" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <MudTextField @bind-Value="model.Email"
                          Label="Email"
                          For="@(() => model.Email)"
                          Required="true" />

            <MudTextField @bind-Value="model.Password"
                          Label="Contraseña"
                          For="@(() => model.Password)"
                          InputType="InputType.Password"
                          Required="true" />

            <MudButton ButtonType="ButtonType.Submit"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Class="mt-2">
                ENTRAR
            </MudButton>
        </EditForm>

        @if (!string.IsNullOrWhiteSpace(error))
        {
            <MudAlert Severity="Severity.Error">@error</MudAlert>
        }
    </MudStack>
</MudPaper>

@code {
    private UserLoginDTO model = new();
    private string? error;

    private async Task HandleLogin()
    {
        try
        {
            error = null;

            var http = HttpFactory.CreateClient("api");

            var resp = await http.PostAsJsonAsync("api/Users/login", model);

            if (!resp.IsSuccessStatusCode)
            {
                error = "Credenciales inválidas.";
                return;
            }

            var tokenDto = await resp.Content.ReadFromJsonAsync<TokenDTO>();
            if (tokenDto is null || string.IsNullOrWhiteSpace(tokenDto.Token))
            {
                error = "No llegó token.";
                return;
            }

            Tokens.Save(tokenDto.Token);

     
            Nav.NavigateTo("/employees", forceLoad: true);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    public class UserLoginDTO
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;
    }

    public class TokenDTO
    {
        public string Token { get; set; } = string.Empty;
        public DateTime Expiration { get; set; }
    }
}
